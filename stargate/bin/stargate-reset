#!/usr/bin/env ruby

require 'fileutils'
require 'date'

# Configuration
PROJECT_ROOT = File.expand_path('../..', __dir__)
APP_MAIN_PATH = File.join(PROJECT_ROOT, 'app', 'main.rb')
INDEX_YAML_PATH = File.join(PROJECT_ROOT, 'stargate', 'index.yaml')

# Seed Content for app/main.rb
MAIN_RB_SEED = <<~RUBY
  # --- STARGATE-SOVEREIGN-BRIDGE START ---
  require "stargate/bootstrap.rb"

  def tick args
    # Law 1.1: Render First (Pulse)
    Stargate::Avatar.render(args, fail_safe: $stargate_fail_safe)
    
    begin
      unless Stargate.status[:booted]
        Stargate.initialize_context(args)
      end

      # Your sovereign simulation begins here
      run_game_tick(args)
    rescue => e
      # Law 10.1: Fail-Safe Visual
      $stargate_fail_safe = e
    end
  end

  def run_game_tick(args)
    args.outputs.labels << {
      x: 640, y: 360,
      text: "Stargate: Sovereign Flow Active (Seed State)",
      alignment_enum: 1, r: 0, g: 151, b: 231
    }
  end
  # --- STARGATE-SOVEREIGN-BRIDGE END ---
RUBY

# Seed Content for stargate/index.yaml
INDEX_YAML_SEED = <<~YAML
  version: 1.0.0
  updated_at: #{Date.today.iso8601}
  context: "New Stargate Project (Seed State)"

  nodes:
    system.core:
      description: "Sovereign Bridge entry point and main loop definition"
      files:
        - path: "app/main.rb"
          ranges: ["1-23"]
      primary_responsibility: "Boot & Lifecycle"
      dependencies: ["stargate/bootstrap.rb"]
YAML

def timestamp_backup_name(path)
  ext = File.extname(path)
  base = File.basename(path, ext)
  dir = File.dirname(path)
  timestamp = Time.now.strftime('%Y%m%d_%H%M%S')
  File.join(dir, "#{base}_backup_#{timestamp}#{ext}")
end

puts "ðŸŒŒ Stargate: Initiating Sovereign Reset Protocol..."

# 1. Backup existing state
[APP_MAIN_PATH, INDEX_YAML_PATH].each do |file|
  if File.exist?(file)
    backup = timestamp_backup_name(file)
    FileUtils.cp(file, backup)
    puts "   ðŸ“¦ Backup created: #{File.basename(backup)}"
  end
end

# 2. Reset Code
File.write(APP_MAIN_PATH, MAIN_RB_SEED)
puts "   âœ¨ Code Reset: app/main.rb restored to seed."

# 3. Reset Index
File.write(INDEX_YAML_PATH, INDEX_YAML_SEED)
puts "   âœ¨ Index Reset: stargate/index.yaml synchronized to seed."

puts "\nâœ… RESET COMPLETE."
puts "   The Book and the Table of Contents are now blank and synchronized."
puts "   You may begin writing your new story."
